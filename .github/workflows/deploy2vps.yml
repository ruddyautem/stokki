name: Deploy Stokki to VPS

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      WORKING_DIR: /home/autem-stokki/htdocs/stokki.autem.dev
      SSH_USER: ${{ secrets.SSH_USER }}
      SSH_HOST: ${{ secrets.SSH_HOST }}

    steps:
      # 1Ô∏è‚É£ Checkout code
      - name: Checkout code
        uses: actions/checkout@v3

      # 2Ô∏è‚É£ Setup SSH
      - name: Setup SSH
        run: |
          echo "Setting up SSH..."
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          eval "$(ssh-agent -s)"
          ssh-add ~/.ssh/id_rsa
          ssh-keyscan -H $SSH_HOST >> ~/.ssh/known_hosts
          echo "SSH setup complete."

      # 3Ô∏è‚É£ Test SSH connection
      - name: Test SSH connection
        run: |
          echo "Testing SSH connection to $SSH_USER@$SSH_HOST..."
          ssh -o StrictHostKeyChecking=no $SSH_USER@$SSH_HOST "whoami && pwd"

      # 4Ô∏è‚É£ Clean old build
      - name: Clean previous build
        run: |
          echo "Cleaning old build..."
          ssh -o StrictHostKeyChecking=no $SSH_USER@$SSH_HOST "cd $WORKING_DIR && rm -rf .next"
          echo "Old build cleaned."

      # 5Ô∏è‚É£ Reset git state
      - name: Reset git state
        run: |
          echo "Resetting git state..."
          ssh -o StrictHostKeyChecking=no $SSH_USER@$SSH_HOST "cd $WORKING_DIR && git reset --hard HEAD"
          echo "Git state reset."

      # 6Ô∏è‚É£ Pull latest code
      - name: Pull latest code
        run: |
          echo "Pulling latest code..."
          ssh -o StrictHostKeyChecking=no $SSH_USER@$SSH_HOST "cd $WORKING_DIR && git pull origin main"
          echo "Code pulled."

      # 7Ô∏è‚É£ Install dependencies
      - name: Install dependencies
        run: |
          echo "Installing dependencies..."
          ssh -o StrictHostKeyChecking=no $SSH_USER@$SSH_HOST "cd $WORKING_DIR && /home/ruddya/.bun/bin/bun install"
          echo "Dependencies installed."

      # 8Ô∏è‚É£ Build project
      - name: Build project
        run: |
          echo "Building project..."
          ssh -o StrictHostKeyChecking=no $SSH_USER@$SSH_HOST "cd $WORKING_DIR && /home/ruddya/.bun/bin/bun run build"
          echo "Build complete."

      # 9Ô∏è‚É£ Reload PM2
      - name: Reload PM2
        run: |
          echo "Reloading PM2..."
          ssh -o StrictHostKeyChecking=no $SSH_USER@$SSH_HOST "cd $WORKING_DIR && pm2 reload pm2.config.cjs --update-env && pm2 save"
          echo "PM2 reloaded."

      # üîü Cleanup SSH key
      - name: Cleanup SSH key
        run: |
          echo "Removing private SSH key..."
          rm -f ~/.ssh/id_rsa
          echo "Private key removed."
